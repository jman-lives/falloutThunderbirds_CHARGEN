<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Character Advancement & Perks</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="container">
    <h1>Character Advancement & Perks</h1>

    <div class="controls" style="margin-bottom: 16px;">
      <a href="index.html" style="display: inline-block; padding: 6px 12px; background-color: #2196F3; color: white; border: none; border-radius: 4px; text-decoration: none; cursor: pointer; font-weight: bold;">← Back to Home</a>
    </div>

    <!-- Character Summary -->
    <div style="padding: 12px; background-color: #333; border-radius: 4px; margin-bottom: 16px; border-left: 4px solid #FF9800;">
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
        <div>
          <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #aaa;">Character</p>
          <p style="margin: 0; font-weight: bold;" id="char-name">Unknown</p>
        </div>
        <div>
          <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #aaa;">Race</p>
          <p style="margin: 0; font-weight: bold;" id="char-race">Human</p>
        </div>
        <div>
          <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #aaa;">Level</p>
          <p style="margin: 0; font-weight: bold; color: #4CAF50; font-size: 1.1rem;" id="char-level">1</p>
        </div>
        <div>
          <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #aaa;">XP</p>
          <p style="margin: 0; font-size: 0.9rem;" id="char-xp">0 XP</p>
        </div>
        <div>
          <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #aaa;">HP</p>
          <p style="margin: 0; font-size: 0.9rem;" id="char-hp">15</p>
        </div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px;">
        <div>
          <p style="margin: 0; font-size: 0.75rem; color: #aaa;">STR</p>
          <p style="margin: 0; font-weight: bold; color: #4CAF50;" id="char-str">5</p>
        </div>
        <div>
          <p style="margin: 0; font-size: 0.75rem; color: #aaa;">PER</p>
          <p style="margin: 0; font-weight: bold; color: #4CAF50;" id="char-per">5</p>
        </div>
        <div>
          <p style="margin: 0; font-size: 0.75rem; color: #aaa;">END</p>
          <p style="margin: 0; font-weight: bold; color: #4CAF50;" id="char-end">5</p>
        </div>
        <div>
          <p style="margin: 0; font-size: 0.75rem; color: #aaa;">CHR</p>
          <p style="margin: 0; font-weight: bold; color: #4CAF50;" id="char-chr">5</p>
        </div>
        <div>
          <p style="margin: 0; font-size: 0.75rem; color: #aaa;">INT</p>
          <p style="margin: 0; font-weight: bold; color: #4CAF50;" id="char-int">5</p>
        </div>
        <div>
          <p style="margin: 0; font-size: 0.75rem; color: #aaa;">AGI</p>
          <p style="margin: 0; font-weight: bold; color: #4CAF50;" id="char-agi">5</p>
        </div>
        <div>
          <p style="margin: 0; font-size: 0.75rem; color: #aaa;">LCK</p>
          <p style="margin: 0; font-weight: bold; color: #4CAF50;" id="char-lck">5</p>
        </div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
        <div>
          <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #aaa;">Tag Skills</p>
          <p style="margin: 0; font-size: 0.9rem;" id="char-tags">None</p>
        </div>
        <div>
          <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #aaa;">Traits</p>
          <p style="margin: 0; font-size: 0.9rem;" id="char-traits">None</p>
        </div>
        <div>
          <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #aaa;">Top Skill</p>
          <p style="margin: 0; font-size: 0.9rem;" id="char-top-skill">-</p>
        </div>
      </div>
    </div>

    <form id="char-form">
      <section id="skills-section">
        <h2>Rank Up Skills</h2>
        <div style="margin-bottom: 12px;">
          <p style="font-size: 0.9rem; color: #aaa; margin: 0 0 8px 0;">Allocate available skill points to improve skills. Tag skills gain 2% per point, other skills gain 1% per point.</p>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px; align-items: end;">
            <div style="padding: 8px; background-color: #333; border-radius: 4px; border-left: 3px solid #2196F3;">
              <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #aaa;">Skill Points Available</p>
              <p style="margin: 0; font-weight: bold; color: #2196F3; font-size: 1.1rem;" id="skill_points_available">0</p>
            </div>
            <div style="padding: 8px; background-color: #333; border-radius: 4px; border-left: 3px solid #FF9800;">
              <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #aaa;">Skill Points Used</p>
              <p style="margin: 0; font-weight: bold; color: #FF9800; font-size: 1.1rem;" id="skill_points_used">0</p>
            </div>
            <button type="button" id="reset-skill-points-btn" style="padding: 16px; background-color: #9C27B0; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; height: 100%;">Reset Skill Points</button>
          </div>
        </div>

        <div id="skills-list" style="padding: 8px; background-color: #444; border-radius: 4px; border: 1px solid #555;">
          <p id="no-skills-msg" style="margin: 0; color: #999;">No skills available.</p>
          <div id="skills-container"></div>
        </div>
      </section>

      <div style="margin-top: 12px; display: flex; gap: 12px;">
        <button type="button" id="confirm-skill-allocation-btn" style="flex: 1; padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;" disabled>Confirm Skill Allocation</button>
      </div>

      <section id="perks-section">
        <h2>Perks</h2>
        <div style="margin-bottom: 12px;">
          <label>Perks Gained: <span id="perks_earned">0</span></label>
          <p style="font-size: 0.9rem; color: #aaa;">Perks are gained at levels 3, 6, 9, 12, 15, 18, 21, 24, etc.</p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px;">
          <!-- Available Perks Column -->
          <div>
            <h3 style="margin: 0 0 8px 0; font-size: 0.95rem; color: #4CAF50;">Available Perks</h3>
            <div id="perks-list" style="padding: 8px; background-color: #444; border-radius: 4px; min-height: 300px; max-height: 600px; overflow-y: auto; border: 1px solid #555;">
              <p id="no-perks-msg" style="margin: 0; color: #999;">No perks available yet.</p>
              <div id="available-perks-container"></div>
            </div>
          </div>

          <!-- Selected Perks Column -->
          <div>
            <h3 style="margin: 0 0 8px 0; font-size: 0.95rem; color: #ff9800;">Selected Perks (<span id="selected_perks_count">0</span> / <span id="max_selectable_perks">0</span>)</h3>
            <div id="selected-perks-list" style="padding: 8px; background-color: #333; border-radius: 4px; min-height: 300px; max-height: 600px; overflow-y: auto; border: 2px solid #ff9800;">
              <p id="no-selected-perks-msg" style="margin: 0; color: #999;">No perks selected yet.</p>
              <div id="selected-perks-container"></div>
            </div>
          </div>
        </div>
      </section>

      <div style="margin-top: 12px; display: flex; gap: 12px;">
        <button type="button" id="confirm-perk-selection-btn" style="flex: 1; padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;" disabled>Confirm Perk Selection</button>
      </div>

      <section>
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <button type="button" id="level-up-btn" style="width: 100%; padding: 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1.2rem;">Level Up</button>
          <button type="button" id="download" style="width: 100%; padding: 20px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1.2rem; display: none;">Download JSON</button>
          <a href="equipmentchoice.html" id="equipment-choice-btn" style="width: 100%; padding: 20px; background-color: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1.2rem; text-decoration: none; text-align: center; display: none;">Equipment Selection →</a>
        </div>
      </section>
    </form>

    <pre id="output" aria-live="polite"></pre>
  </main>

  <script src="script.js?v=1"></script>
  <script>
    // Set the equipment button flag EARLY before other scripts run
    // If coming from levelup session, ALWAYS show download (not equipment)
    const isLevelUpSession = localStorage.getItem('isLevelUpSession') === 'true';
    const fromChargen = localStorage.getItem('fromChargen') === 'true' && !isLevelUpSession;
    window.showEquipmentButton = fromChargen;
    console.log('[advancement.html] isLevelUpSession:', isLevelUpSession, 'fromChargen:', fromChargen, 'showEquipmentButton:', window.showEquipmentButton);
  </script>
  <script src="advancement.js?v=1"></script>
  <script src="advancement-page.js?v=1"></script>
  <script>
    // Hide/show buttons initially based on source
    document.addEventListener('DOMContentLoaded', () => {
      const downloadBtn = qs('download');
      const equipmentBtn = qs('equipment-choice-btn');
      
      // Set initial visibility - both start hidden, will be shown by advancement-page.js after leveling
      if (downloadBtn) {
        downloadBtn.style.display = 'none';
      }
      if (equipmentBtn) {
        equipmentBtn.style.display = 'none';
      }
    });
  </script>
</body>
</html>
